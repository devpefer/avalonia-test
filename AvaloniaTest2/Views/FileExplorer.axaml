<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="clr-namespace:AvaloniaTest2.Models"
             xmlns:viewModels="clr-namespace:AvaloniaTest2.ViewModels"
             xmlns:converters="clr-namespace:AvaloniaTest2.Converters"
             xmlns:io="clr-namespace:System.IO;assembly=System.IO.FileSystem.DriveInfo"
             x:Class="AvaloniaTest2.Views.FileExplorer"
             x:DataType="viewModels:FileExplorerViewModel">

    <UserControl.Resources>
        <converters:BoolToStatusConverter x:Key="BoolToStatusConverter" />
        <converters:BytesToMbConverter x:Key="BytesToMbConverter" />
    </UserControl.Resources>

    <!-- Capa principal: el contenido scrolleable + la barra fija -->
    <Grid>
        <!-- Contenido desplazable -->
        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
            <Grid RowDefinitions="Auto,Auto,100,Auto,Auto,*" Margin="5">
                <ComboBox Grid.Row="0"
                          ItemsSource="{Binding SortModes}"
                          SelectedItem="{Binding SelectedSort, Mode=TwoWay}"
                          Width="150" Margin="0,0,0,5" />

                <TextBlock Grid.Row="1" Text="Unidades"
                           Foreground="Gray"
                           Margin="5,0,0,0" />
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                    <ListBox x:Name="Drives" ItemsSource="{Binding Drives}">
                        <ListBox.DataTemplates>
                            <TreeDataTemplate DataType="io:DriveInfo" ItemsSource="{Binding}">
                                <Grid ColumnDefinitions="200,100,100,60,100" Margin="0,0,5,0">
                                    <!-- Nombre de la unidad -->
                                    <TextBlock Grid.Column="0" Text="{Binding Name}" 
                                               HorizontalAlignment="Left" />

                                    <!-- Etiqueta "Available" -->
                                    <TextBlock Grid.Column="1" Text="Available" 
                                               HorizontalAlignment="Right" />

                                    <!-- Espacio libre -->
                                    <TextBlock Grid.Column="2" 
                                               Text="{Binding TotalFreeSpace, Converter={StaticResource BytesToMbConverter}}" 
                                               Foreground="Gray" 
                                               HorizontalAlignment="Right" />

                                    <!-- Etiqueta "Total" -->
                                    <TextBlock Grid.Column="3" Text="Total" 
                                               HorizontalAlignment="Right" />

                                    <!-- Tamaño total -->
                                    <TextBlock Grid.Column="4" 
                                               Text="{Binding TotalSize, Converter={StaticResource BytesToMbConverter}}" 
                                               Foreground="Gray" 
                                               HorizontalAlignment="Right" />
                                </Grid>
                            </TreeDataTemplate>

                        </ListBox.DataTemplates>
                    </ListBox>
                </ScrollViewer>

                <TextBlock Grid.Row="3" Text="Almacenamiento"
                           Foreground="Gray"
                           Margin="5,10,0,0" />
                
                <StackPanel Grid.Row="4" Orientation="Horizontal" Spacing="5" Margin="5">
                    <TextBox Width="200" Watermark="Buscar..."
                             Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}" />
                    <Button Content="Buscar" Command="{Binding SearchCommand}" />
                    <Button Content="Anterior" Command="{Binding PrevResultCommand}" />
                    <Button Content="Siguiente" Command="{Binding NextResultCommand}" />
                    <Button Content="Cancelar" Command="{Binding CancelSearchCommand}" />
                    <TextBlock Text="{Binding SearchStatus}" Foreground="Gray" VerticalAlignment="Center"/>
                </StackPanel>

                <ScrollViewer Grid.Row="5" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                    <TreeView x:Name="Tree" ItemsSource="{Binding RootItems}">
                        <TreeView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Abrir"
                                          Command="{Binding OpenFileCommand}"
                                          CommandParameter="{Binding SelectedItem, ElementName=Tree}" />
                                <MenuItem Header="Abrir carpeta contenedora"
                                          Command="{Binding OpenFolderCommand}"
                                          CommandParameter="{Binding SelectedItem, ElementName=Tree}" />
                                <MenuItem Header="Copiar ruta"
                                          Command="{Binding CopyPathCommand}"
                                          CommandParameter="{Binding SelectedItem, ElementName=Tree}" />
                                <MenuItem Header="Mover a la papelera"
                                          Command="{Binding MoveToTrashCommand}"
                                          CommandParameter="{Binding SelectedItem, ElementName=Tree}" />
                            </ContextMenu>
                        </TreeView.ContextMenu>
                        <TreeView.DataTemplates>
                            <TreeDataTemplate DataType="models:FileSystemItem"
                                              ItemsSource="{Binding Children}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding Name}" />
                                    <TextBlock Text=" " />
                                    <TextBlock Text="{Binding DisplaySize}" Foreground="Gray" />
                                </StackPanel>
                            </TreeDataTemplate>
                        </TreeView.DataTemplates>
                    </TreeView>
                </ScrollViewer>
            </Grid>
        </ScrollViewer>

        <!-- Barra inferior fija y superpuesta -->
        <StackPanel VerticalAlignment="Bottom"
                    Background="White"
                    Margin="5"
                    Spacing="4">
            <ProgressBar IsIndeterminate="True"
                         Height="20"
                         IsVisible="{Binding IsCalculatingSizes}" />
            <TextBlock Text="Calculando tamaños..."
                       Foreground="Gray"
                       IsVisible="{Binding IsCalculatingSizes}" />
            <TextBlock Text="{Binding CurrentItemBeingProcessed}"
                       Foreground="Gray"
                       Margin="5,0,0,0" />
        </StackPanel>
    </Grid>
</UserControl>
